<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vi·ªát store</title>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f4; 
            color: #333;
        }
        .container { 
            width: 90%; 
            max-width: 1200px;
            margin: 20px auto; 
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .header { 
            background: #333; 
            color: white; 
            padding: 15px 5%;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .header a:hover {
            background: #555;
        }
        .product-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .product-card { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            text-align: center;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .product-card h3 { 
            color: #007bff; 
            margin-top: 0;
        }
        .product-card button { 
            background-color: #28a745; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: 5px; 
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .product-card button:hover {
            background-color: #218838;
        }
        .checkout-button {
            background-color: #dc3545 !important;
        }
        
        /* CSS cho Gi·ªè h√†ng v√† Checkout */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .cart-controls button { margin: 0 5px; padding: 5px 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .checkout-form label { display: block; margin-top: 10px; font-weight: bold; }
        .checkout-form input[type="text"], .checkout-form input[type="tel"] { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        
        /* CSS cho Admin Table */
        .order-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .order-table th, .order-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; font-size: 0.9em;}
        .order-table th { background-color: #f0f8ff; }
        .status-new { color: orange; font-weight: bold; }
        .status-confirmed { color: blue; font-weight: bold; }
        .status-packaging, .status-shipping { color: purple; font-weight: bold; }
        .status-done { color: green; font-weight: bold; }

        /* CSS cho thanh T√¨m ki·∫øm */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        .search-bar input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-bar button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .search-bar button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vi·ªát Store </h1>
        <nav>
            <a href="javascript:void(0)" onclick="router.navigate('/home')">Trang Ch·ªß</a> 
            <a href="javascript:void(0)" onclick="router.navigate('/cart')" id="cart-link">Gi·ªè H√†ng (0)</a> 
            <a href="javascript:void(0)" onclick="router.navigate('/admin')">Qu·∫£n Tr·ªã ƒê∆°n h√†ng</a> 
            <a href="javascript:void(0)" onclick="router.navigate('/login')">ƒêƒÉng Nh·∫≠p</a>
        </nav>
    </div>
    
    <div id="app" class="container">
        ƒêang t·∫£i...
    </div>

    <script>
        // --- 1. C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ---
        const API_URL = 'http://localhost/api'; 
        // const API_URL = 'http://localhost:1880/api'; // D√πng c·ªïng Node-RED tr·ª±c ti·∫øp n·∫øu c·∫ßn
        
        const appElement = document.getElementById('app');
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let products = []; 
        let userSession = null; 
        
        // --- 2. H√ÄM X·ª¨ L√ù CHUNG ---
        function formatCurrency(amount) {
            const numericAmount = Number(amount);
            if (isNaN(numericAmount)) return 'N/A';
            return numericAmount.toLocaleString('vi-VN') + ' VND';
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-link').textContent = `Gi·ªè H√†ng (${totalItems})`;
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'confirmed': return 'status-confirmed';
                case 'packaging':
                case 'shipping': return 'status-packaging';
                case 'done': return 'status-done';
                default: return '';
            }
        }

        // --- 3. ƒê·ªäNH TUY·∫æN (ROUTER) ---
        const routes = {
            '/home': renderHomePage,
            '/cart': renderCartPage,
            '/checkout': renderCheckoutPage,
            '/login': renderLoginPage,
            '/admin': renderAdminPage
        };

        const router = {
            navigate: async (path) => {
                window.history.pushState(null, null, '#' + path);
                await router.loadPage(path);
            },
            loadPage: async (path) => {
                const cleanPath = path.startsWith('#') ? path.substring(1) : path;
                const handler = routes[cleanPath] || routes['/home'];
                appElement.innerHTML = 'ƒêang t·∫£i...';
                await handler(appElement);
                updateCartCount();
            }
        };
        window.router = router;

        window.addEventListener('popstate', () => {
            router.loadPage(window.location.hash.replace('#', '') || '/home');
        });

        // --- 4. H√ÄM RENDER V√Ä LOGIC API ---
        
        // H√†m fetch Best Sellers (GI·ªÆ NGUY√äN)
        async function fetchBestSellers() {
            try {
                const response = await fetch(`${API_URL}/best-sellers`); 
                const result = await response.json();
                return (result.success && result.products) ? result.products : [];
            } catch (error) {
                console.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API Best Sellers Backend.', error);
                return [];
            }
        }
        
        // H√†m fetch My Products (GI·ªÆ NGUY√äN)
        async function fetchMyProducts(userId) {
            try {
                const response = await fetch(`${API_URL}/my-products`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer user_id:${userId}` 
                    }
                }); 
                const result = await response.json();
                return (result.success && result.products) ? result.products : [];
            } catch (error) {
                console.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API My Products Backend.', error);
                return [];
            }
        }

        // üÜï H√ÄM FETCH SEARCH RESULTS
        async function fetchSearchResults(query) {
            if (!query) return [];
            try {
                const response = await fetch(`${API_URL}/products/search?q=${encodeURIComponent(query)}`); 
                const result = await response.json();
                return (result.success && result.products) ? result.products : [];
            } catch (error) {
                console.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API Search Products Backend.', error);
                return [];
            }
        }
        
        // H√†m t·∫°o HTML danh s√°ch s·∫£n ph·∫©m (GI·ªÆ NGUY√äN)
        function createProductListHTML(title, products, type = 'general') {
            if (products.length === 0 && type !== 'my-products') return `<h2 style="color: #333; margin-top: 30px;">${title}</h2><p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>`;
            if (products.length === 0 && type === 'best-seller') return ''; 
            if (products.length === 0 && type === 'search-results') return `<h2 style="color: #333; margin-top: 30px;">${title}</h2><p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi t·ª´ kh√≥a.</p>`;

            let color = '#333';
            let badge = '';
            let cardStyle = '';

            if (type === 'best-seller') {
                color = '#dc3545';
                cardStyle = 'border: 3px solid #dc3545; position: relative; overflow: hidden;';
                badge = '<span style="background-color: #ffc107; color: #333; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; position: absolute; top: 10px; right: 10px; font-weight: bold; transform: rotate(5deg);">üî• BEST SELLER</span>';
            } else if (type === 'my-products') {
                color = '#007bff';
                cardStyle = 'border: 3px solid #007bff; position: relative; overflow: hidden;';
                badge = '<span style="background-color: #007bff; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; position: absolute; top: 10px; right: 10px; font-weight: bold; transform: rotate(5deg);">OWNER</span>';
                if (products.length === 0) return `<h2 style="color: ${color}; margin-top: 30px;">${title}</h2><p>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>`;
            } else if (type === 'search-results') {
                color = '#007bff';
            }

            let html = `<h2 style="color: ${color}; margin-top: 30px;">${title}</h2><div class="product-list">`;
            products.forEach(product => {
                const productDescription = product.description || 'Kh√¥ng c√≥ m√¥ t·∫£.'; 

                html += `
                    <div class="product-card" style="${cardStyle}">
                        ${type === 'general' || type === 'search-results' ? '' : badge}
                        <h3>${product.name}</h3>
                        <p>${productDescription.length > 50 ? productDescription.substring(0, 50) + '...' : productDescription}</p>
                        <p>Gi√°: ${formatCurrency(product.price)}</p>
                        <button onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price})">Th√™m v√†o Gi·ªè</button>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        window.createProductListHTML = createProductListHTML;

        // üÜï H√ÄM X·ª¨ L√ù T√åM KI·∫æM
        async function handleSearch() {
            const query = document.getElementById('search-input').value.trim();
            const resultsElement = document.getElementById('search-results');
            
            if (!query) {
                // N·∫øu kh√¥ng c√≥ query, load l·∫°i trang ch·ªß ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£
                router.navigate('/home'); 
                return;
            }

            resultsElement.innerHTML = '<p>ƒêang t√¨m ki·∫øm...</p>';
            
            const searchResults = await fetchSearchResults(query);

            let html = createProductListHTML(`üîç K·∫øt Qu·∫£ T√¨m Ki·∫øm cho: "${query}"`, searchResults, 'search-results');
            
            // X√≥a c√°c ph·∫ßn Best Sellers v√† All Products kh·ªèi DOM
            document.getElementById('product-sections').style.display = 'none';

            resultsElement.innerHTML = html;
        }
        window.handleSearch = handleSearch;


        // --- Trang Ch·ªß (S·∫£n ph·∫©m) - ƒê√É S·ª¨A ƒê·ªîI ---
        async function renderHomePage(element) {
            element.innerHTML = 'ƒêang t·∫£i s·∫£n ph·∫©m...';
            
            let html = `
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m c·∫ßn t√¨m..." onkeyup="if(event.keyCode === 13) handleSearch()">
                    <button onclick="handleSearch()">T√¨m Ki·∫øm</button>
                </div>
                <div id="search-results"></div>
                <div id="product-sections">
            `;

            // 1. Hi·ªÉn th·ªã S·∫¢N PH·∫®M C·ª¶A T√îI (n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p)
            if (userSession && userSession.id) {
                const myProducts = await fetchMyProducts(userSession.id);
                html += createProductListHTML(`üè† S·∫¢N PH·∫®M C·ª¶A T√îI (User ID: ${userSession.id})`, myProducts, 'my-products');
            } 
            
            // 2. L·∫•y danh s√°ch S·∫£n ph·∫©m B√°n ch·∫°y
            const bestSellers = await fetchBestSellers(); 

            // 3. L·∫•y danh s√°ch S·∫£n ph·∫©m chung (Ch·ªâ load 1 l·∫ßn)
            if (products.length === 0) {
                try {
                    const response = await fetch(`${API_URL}/products`);
                    const result = await response.json();
                    if (result.success) {
                        products = result.products;
                    } else {
                        html += `<p style="color: red;">L·ªói t·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m: ${result.message}</p>`;
                    }
                } catch (error) {
                    html += `<p style="color: red;">Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m: L·ªói k·∫øt n·ªëi API.</p>`;
                    console.error('Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ s·∫£n ph·∫©m:', error);
                }
            }

            // 4. Hi·ªÉn th·ªã Best Sellers v√† All Products
            html += createProductListHTML('üî• S·∫¢N PH·∫®M B√ÅN CH·∫†Y NH·∫§T TRONG 30 NG√ÄY', bestSellers, 'best-seller');
            html += createProductListHTML('T·∫•t C·∫£ S·∫£n Ph·∫©m (Kho)', products.filter(p => !bestSellers.some(bs => bs.id === p.id)), 'general'); // Lo·∫°i b·ªè best sellers kh·ªèi danh s√°ch chung
            
            html += '</div>';
            element.innerHTML = html;
            
            // Kh√¥i ph·ª•c tr·∫°ng th√°i t√¨m ki·∫øm n·∫øu c√≥
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1]);
            const initialQuery = urlParams.get('q');
            if (initialQuery) {
                document.getElementById('search-input').value = initialQuery;
                handleSearch();
            }
        }

        // --- Logic Gi·ªè h√†ng ---
        function addToCart(id, name, price) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id, name, price, quantity: 1 });
            }
            updateCartCount();
            alert(`ƒê√£ th√™m ${name} v√†o gi·ªè h√†ng.`);
        }

        function updateCartItem(id, quantity) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.quantity = quantity;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== id);
                }
            }
            updateCartCount();
            router.loadPage('/cart');
        }
        window.updateCartItem = updateCartItem;
        window.addToCart = addToCart;

        // --- Trang Gi·ªè h√†ng (GI·ªÆ NGUY√äN) ---
        function renderCartPage(element) {
            let html = '<h2>üõí Gi·ªè H√†ng C·ªßa B·∫°n</h2>';
            let total = 0;

            if (cart.length === 0) {
                html += '<p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>';
            } else {
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    html += `
                        <div class="cart-item">
                            <div>
                                <h4>${item.name}</h4>
                                <p>${formatCurrency(item.price)} x ${item.quantity} = <b>${formatCurrency(itemTotal)}</b></p>
                            </div>
                            <div class="cart-controls">
                                <button onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <h3 style="margin-top: 20px;">T·ªïng C·ªông: <span style="color: #dc3545;">${formatCurrency(total)}</span></h3>
                    <button class="checkout-button" onclick="router.navigate('/checkout')" style="padding: 15px; font-size: 1.2em;">
                        Ti·∫øn h√†nh ƒê·∫∑t h√†ng
                    </button>
                `;
            }
            element.innerHTML = html;
        }

        // --- Trang ƒê·∫∑t h√†ng (Checkout) ---
        function renderCheckoutPage(element) {
            if (cart.length === 0) {
                element.innerHTML = '<p>Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ thanh to√°n.</p><button onclick="router.navigate(\'/home\')">V·ªÅ trang ch·ªß</button>';
                return;
            }

            let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            let html = `
                <h2>üìù Th√¥ng tin Giao h√†ng</h2>
                <div class="checkout-form">
                    <label for="name">H·ªç t√™n:</label>
                    <input type="text" id="name" required value="${userSession ? userSession.username : 'Kh√°ch v√£ng lai'}">
                    
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="phone" required value="0987654321">
                    
                    <label for="address">ƒê·ªãa ch·ªâ:</label>
                    <input type="text" id="address" required value="Th√°i Nguy√™n">
                    
                    <h3 style="margin-top: 20px;">T·ªïng ti·ªÅn: ${formatCurrency(total)}</h3>
                    <div id="checkout-status" style="margin-top: 10px; font-weight: bold;"></div>

                    <button onclick="submitOrder(${total})" 
                        style="width: 100%; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1.1em; margin-top: 20px;">
                        HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG
                    </button>
                </div>
            `;
            element.innerHTML = html;
        }

        // --- LOGIC ƒê·∫∂T H√ÄNG M·ªöI (GI·ªÆ NGUY√äN) ---
        async function submitOrder(totalAmount) {
            const statusElement = document.getElementById('checkout-status');
            statusElement.style.color = 'black';
            statusElement.textContent = 'ƒêang g·ª≠i ƒë∆°n h√†ng...';
            
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            if (!name || !phone || !address) {
                statusElement.style.color = 'red';
                statusElement.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng.';
                return;
            }

            const orderData = {
                // S·ª≠ d·ª•ng ID th·ª±c n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ng∆∞·ª£c l·∫°i d√πng 0 cho kh√°ch v√£ng lai
                user_id: userSession ? userSession.id : 0, 
                total_amount: totalAmount,
                // G·ª≠i th√¥ng tin giao h√†ng d∆∞·ªõi d·∫°ng object
                delivery_info: { recipient_name: name, phone, address }, 
                // G·ª≠i chi ti·∫øt s·∫£n ph·∫©m
                items: cart.map(item => ({
                    id: item.id, // ƒê√£ ƒë·ªïi t√™n th√†nh 'id' ƒë·ªÉ kh·ªõp v·ªõi logic Node-RED
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            try {
                const response = await fetch(`${API_URL}/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    statusElement.style.color = 'green';
                    statusElement.textContent = `‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! ID ƒê∆°n h√†ng: ${result.order_id}`;
                    
                    alert(`ƒê∆°n h√†ng #${result.order_id} ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t th√†nh c√¥ng!`);
                    cart = []; // X√≥a gi·ªè h√†ng
                    updateCartCount();
                    
                    // Ch·ªù 2 gi√¢y r·ªìi chuy·ªÉn v·ªÅ trang ch·ªß (ho·∫∑c l√†m m·ªõi d·ªØ li·ªáu)
                    setTimeout(() => router.navigate('/home'), 2000); 
                    
                } else {
                    statusElement.style.color = 'red';
                    statusElement.textContent = `‚ùå ƒê·∫∑t h√†ng th·∫•t b·∫°i: ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                    alert(`ƒê·∫∑t h√†ng th·∫•t b·∫°i: ${result.message || 'L·ªói server.'}`);
                }

            } catch (error) {
                statusElement.style.color = 'red';
                statusElement.textContent = "‚ùå L·ªói k·∫øt n·ªëi t·ªõi Backend khi ƒë·∫∑t h√†ng.";
                console.error("Order API Error:", error);
            }
        }
        window.submitOrder = submitOrder;

        // --- Trang ƒêƒÉng nh·∫≠p (GI·ªÆ NGUY√äN) ---
        function renderLoginPage(element) {
            if (userSession) {
                element.innerHTML = `<p>B·∫°n ƒëang ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n: <b>${userSession.username} (ID: ${userSession.id})</b></p>
                    <button onclick="handleLogout()">ƒêƒÉng Xu·∫•t</button>
                    <button onclick="router.navigate('/home')">V·ªÅ Trang Ch·ªß</button>`;
                return;
            }
            
            const loginHtml = `
                <div style="max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff;">
                    <h2 style="text-align: center; color: #333; margin-bottom: 25px;">ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h2>
                    <label for="login-username" style="display: block; margin-bottom: 5px; font-weight: bold;">T√†i kho·∫£n:</label>
                    <input 
                        type="text" 
                        id="login-username" 
                        value="admin" 
                        placeholder="Nh·∫≠p t√†i kho·∫£n"
                        style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                        required
                    >
                    <label for="login-password" style="display: block; margin-bottom: 5px; font-weight: bold;">M·∫≠t kh·∫©u:</label>
                    <input 
                        type="password" 
                        id="login-password" 
                        value="adminpass" 
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                        style="width: 100%; padding: 10px; margin-bottom: 25px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                        required
                    >
                    <button 
                        onclick="handleLogin()" 
                        style="width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s;"
                    >
                        ƒêƒÉng Nh·∫≠p
                    </button>
                </div>
            `;
            element.innerHTML = loginHtml;
        }
        
        async function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/login`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                    // G√°n userSession
                    userSession = result.user; 
                    router.navigate('/home'); 
                } else {
                    alert(`ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ${result.message || 'T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'}`);
                }

            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi t·ªõi server Node-RED khi ƒëƒÉng nh·∫≠p!");
                console.error("Login API Error:", error);
            }
        }
        window.handleLogin = handleLogin;
        
        function handleLogout() {
            userSession = null;
            alert('ƒê√£ ƒëƒÉng xu·∫•t.');
            router.navigate('/home');
        }
        window.handleLogout = handleLogout;


        // --- Trang Admin (GI·ªÆ NGUY√äN) ---
        async function renderAdminPage(element) {
             if (!userSession) {
                 element.innerHTML = '<p style="color: red;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang qu·∫£n tr·ªã.</p><button onclick="router.navigate(\'/login\')">ƒêi t·ªõi trang ƒêƒÉng nh·∫≠p</button>';
                 return;
             }

             // T·∫°m th·ªùi b·ªè qua vi·ªác ki·ªÉm tra vai tr√≤ admin, ch·ªâ c·∫ßn ƒëƒÉng nh·∫≠p l√† xem ƒë∆∞·ª£c
             
             element.innerHTML = '<h2>üõ†Ô∏è Trang Qu·∫£n tr·ªã ƒê∆°n h√†ng</h2><p>ƒêang t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng...</p>';
             
             try {
                 // G·ªåI API ƒê·ªÇ L·∫§Y DANH S√ÅCH ƒê∆†N H√ÄNG (C·∫¶N X√ÇY D·ª∞NG TRONG NODE-RED)
                 const response = await fetch(`${API_URL}/admin/orders`); 
                 const result = await response.json();

                 if (result.success && result.orders) {
                     let html = '<h3>Danh s√°ch ƒê∆°n h√†ng (C·∫ßn X√°c nh·∫≠n)</h3>';
                     
                     if (result.orders.length === 0) {
                         html += '<p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
                     } else {
                          html += `
                              <table class="order-table">
                                  <thead>
                                      <tr>
                                          <th>ID</th>
                                          <th>Ng√†y ƒë·∫∑t</th>
                                          <th>Ng∆∞·ªùi ƒë·∫∑t</th>
                                          <th>ƒê·ªãa ch·ªâ giao</th>
                                          <th>T·ªïng ti·ªÅn</th>
                                          <th>Tr·∫°ng th√°i</th>
                                          <th>Chi ti·∫øt SP</th>
                                          <th>Thao t√°c</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                          `;
                          
                          result.orders.forEach(order => {
                              // Ph√¢n t√≠ch JSON cho delivery_info
                              const delivery = JSON.parse(order.delivery_info || '{}'); 
                              
                              // Ph√¢n t√≠ch JSON cho chi ti·∫øt s·∫£n ph·∫©m (Gi·∫£ ƒë·ªãnh Node-RED tr·∫£ v·ªÅ c·ªôt 'items' ch·ª©a JSON string c·ªßa order_details)
                              // L∆∞u √Ω: ƒê√£ s·ª≠a logic n√†y ƒë·ªÉ x·ª≠ l√Ω k·∫øt qu·∫£ Node-RED tr·∫£ v·ªÅ m·∫£ng object tr·ª±c ti·∫øp (nh∆∞ flow Admin Orders m·ªõi)
                              const itemsList = Array.isArray(order.items) ? order.items.map(item => 
                                   `${item.product_name || 'SP'} x ${item.quantity} (${formatCurrency(item.price)})`
                               ).join('<br>') : (order.items || 'N/A');

                              const statusClass = getStatusClass(order.status);
                              
                              html += `
                                  <tr>
                                      <td>#${order.order_id}</td>
                                      <td>${new Date(order.order_date).toLocaleDateString('vi-VN')}</td>
                                      <td>${delivery.recipient_name || 'Kh√°ch'} <br><small>${delivery.phone || 'N/A'}</small></td>
                                      <td>${delivery.address || 'N/A'}</td>
                                      <td><b>${formatCurrency(order.total_amount)}</b></td>
                                      <td class="${statusClass}">${order.status}</td>
                                      <td>${itemsList}</td>
                                      
                                      <td>
                                          ${order.status === 'new' ? 
                                              `<button onclick="updateOrderStatus(${order.order_id}, 'confirmed')" style="background-color: orange; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 4px;">X√°c nh·∫≠n</button>` 
                                              : ''}
                                          ${order.status === 'confirmed' ? 
                                              `<button onclick="updateOrderStatus(${order.order_id}, 'packaging')" style="background-color: blue; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 4px;">ƒê√≥ng g√≥i</button>` 
                                              : ''}
                                          ${(order.status === 'packaging' || order.status === 'shipping') ? 
                                              `<button onclick="updateOrderStatus(${order.order_id}, 'done')" style="background-color: green; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 4px;">Ho√†n t·∫•t</button>` 
                                              : ''}
                                      </td>
                                  </tr>
                              `;
                          });
                          
                          html += '</tbody></table>';
                     }

                     element.innerHTML = html;
                     
                 } else {
                     element.innerHTML = `<p style="color: red;">L·ªói t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng: ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}</p>`;
                 }

             } catch (error) {
                 element.innerHTML = `<h2>L·ªói</h2><p>Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API Admin: ${error.message}</p>`;
                 console.error("Admin API Fetch Error:", error);
             }
        }
        window.renderAdminPage = renderAdminPage;


        // --- LOGIC C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI ƒê∆†N H√ÄNG (GI·ªÆ NGUY√äN) ---
        async function updateOrderStatus(orderId, newStatus) {
            if (!userSession) {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.");
                return;
            }
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn ƒê∆°n h√†ng #${orderId} sang tr·∫°ng th√°i "${newStatus}"?`)) {
                return;
            }
            
            try {
                // G·ªåI API ƒê·ªÇ C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI (C·∫¶N X√ÇY D·ª∞NG TRONG NODE-RED)
                const response = await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        // C√≥ th·ªÉ th√™m Authorization header n·∫øu Node-RED y√™u c·∫ßu x√°c th·ª±c Admin
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message || `ƒê∆°n h√†ng #${orderId} ƒë√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!`);
                    // Load l·∫°i trang Admin sau khi c·∫≠p nh·∫≠t
                    router.navigate('/admin'); 
                } else {
                    alert(`C·∫≠p nh·∫≠t th·∫•t b·∫°i: ${result.message || 'L·ªói server.'}`);
                }

            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi Backend khi c·∫≠p nh·∫≠t tr·∫°ng th√°i.");
                console.error("Update Status Error:", error);
            }
        }
        window.updateOrderStatus = updateOrderStatus;
        
        // --- 5. KH·ªûI CH·∫†Y APP ---
        document.addEventListener('DOMContentLoaded', () => {
            router.loadPage(window.location.hash.replace('#', '') || '/home');
        });
    </script> 
</body>
</html>